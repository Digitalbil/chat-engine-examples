
const assert = require('chai').assert;
const history = require('./src/plugin.js');

const OpenChatFramework = require('ocf');

let pluginchat;
let OCF;

describe('config', function() {

    it('should be configured', function() {

        OCF = OpenChatFramework.create({
            publishKey: 'pub-c-07824b7a-6637-4e6d-91b4-7f0505d3de3f',
            subscribeKey: 'sub-c-43b48ad6-d453-11e6-bd29-0619f8945a4f'
        }, 'test-channel');

        assert.isOk(OCF);

    });

});

describe('connect', function() {

    it('should be identified as new user', function() {

        me = OCF.connect('robot-tester', {works: true});
        assert.isObject(me);

    });

});

let historyChan = 'history-chat-4';

describe('history plugin', function() {

    it('should be created', function(done) {

        let historychat = new OCF.Chat(historyChan);
        let ready = false;

        historychat.on('$ocf.ready', () => {

            historychat.emit('message', {
                text: 'hello world'
            });

            historychat.emit('message', {
                text: 'hello world'
            });

            historychat.emit('message', {
                text: 'hello world'
            });

            if(!ready) {
                done();
                ready = true;
            }

        })

    });

    it('history', function(done) {

        this.timeout(10000);

        let historychat2 = new OCF.Chat(historyChan);
        historychat2.plugin(history());

        historychat2.once("$history.message", (message) => {
            assert.isOk(message);
            done();
        });

    });

});
